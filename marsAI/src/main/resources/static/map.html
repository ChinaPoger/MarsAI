<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è·¯çº¿è§„åˆ’åœ°å›¾</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Microsoft YaHei', 'Segoe UI', Arial, sans-serif;
            height: 100vh;
            display: flex;
            overflow: hidden;
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
        }

        .map-container {
            flex: 1;
            position: relative;
        }

        #map {
            width: 100%;
            height: 100%;
        }

        .info-panel {
            width: 400px;
            background: white;
            box-shadow: -2px 0 15px rgba(0, 0, 0, 0.15);
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            animation: slideInFromRight 0.5s ease-out;
        }

        @keyframes slideInFromRight {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        /* æ»šåŠ¨æ¡ç¾åŒ– */
        .info-panel::-webkit-scrollbar {
            width: 6px;
        }

        .info-panel::-webkit-scrollbar-track {
            background: #f1f1f1;
        }

        .info-panel::-webkit-scrollbar-thumb {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 3px;
        }

        .info-panel::-webkit-scrollbar-thumb:hover {
            background: linear-gradient(135deg, #5568d3 0%, #653487 100%);
        }

        .panel-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 12px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 16px;
            font-weight: bold;
            position: relative;
            overflow: hidden;
        }

        .panel-header::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: linear-gradient(45deg, transparent, rgba(255,255,255,0.1), transparent);
            animation: shimmer 3s infinite;
        }

        @keyframes shimmer {
            0% { transform: translateX(-100%) translateY(-100%) rotate(45deg); }
            100% { transform: translateX(100%) translateY(100%) rotate(45deg); }
        }

        .panel-header > * {
            position: relative;
            z-index: 1;
        }

        .back-button {
            background: rgba(255, 255, 255, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.3);
            color: white;
            padding: 6px 12px;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .back-button:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: translateX(-3px);
        }

        .panel-content {
            flex: 1;
            padding: 12px;
        }

        .info-section {
            margin-bottom: 8px;
            padding: 8px 10px;
            background: linear-gradient(to right, #f8f9fa 0%, #ffffff 100%);
            border-radius: 6px;
            border-left: 3px solid #667eea;
            transition: all 0.3s ease;
            animation: fadeInUp 0.5s ease-out;
        }

        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .info-section:hover {
            box-shadow: 0 2px 8px rgba(102, 126, 234, 0.2);
            transform: translateX(2px);
        }

        .info-section h3 {
            color: #667eea;
            margin-bottom: 4px;
            font-size: 13px;
            font-weight: bold;
            display: inline-block;
            position: relative;
        }

        .info-section h3::after {
            content: '';
            position: absolute;
            left: 0;
            bottom: -2px;
            width: 0;
            height: 2px;
            background: #667eea;
            animation: underline 0.5s ease-out 0.3s forwards;
        }

        @keyframes underline {
            to {
                width: 100%;
            }
        }

        .route-info {
            display: flex;
            justify-content: space-between;
            margin: 4px 0;
            color: #666;
            font-size: 13px;
        }

        .route-info .label {
            font-weight: 600;
            color: #333;
        }

        .weather-info {
            display: flex;
            justify-content: space-between;
            margin: 3px 0;
            color: #666;
            font-size: 12px;
        }

        .weather-info .label {
            font-weight: 600;
            color: #333;
        }

        .steps-list {
            list-style: none;
            padding: 0;
        }

        .steps-list li {
            padding: 10px;
            margin-bottom: 8px;
            background: white;
            border-radius: 6px;
            border-left: 3px solid #667eea;
            color: #555;
            line-height: 1.6;
        }

        .steps-list li::before {
            content: "ğŸ“";
            margin-right: 8px;
        }

        .back-button {
            background: rgba(255, 255, 255, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.3);
            padding: 6px 12px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 13px;
            font-weight: 600;
            color: white;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .back-button:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: scale(1.05);
        }

        .loading {
            text-align: center;
            padding: 50px;
            color: #666;
        }

        /* æ»šåŠ¨æ¡æ ·å¼ */
        .info-panel::-webkit-scrollbar {
            width: 8px;
        }

        .info-panel::-webkit-scrollbar-track {
            background: #f1f1f1;
        }

        .info-panel::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 4px;
        }

        .info-panel::-webkit-scrollbar-thumb:hover {
            background: #555;
        }
        
        /* è·¯çº¿åˆ‡æ¢æŒ‰é’®æ ·å¼ */
        .route-btn {
            transition: all 0.3s ease;
        }
        
        .route-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 2px 6px rgba(102, 126, 234, 0.3);
        }
        
        .route-btn.active {
            font-weight: bold;
        }
    </style>
</head>
<body>
    <div class="map-container">
        <div id="map"></div>
    </div>
    <div class="info-panel">
        <div class="panel-header">
            <span>ğŸ—ºï¸ è·¯çº¿è¯¦æƒ…</span>

        </div>
        <div class="panel-content">
            <!-- é«˜å¾·å®˜æ–¹çš„panelä¼šè‡ªåŠ¨åœ¨æ­¤å¤„æ¸²æŸ“å¯¼èˆªè¯¦æƒ…ï¼ŒåŒ…æ‹¬é©¾è½¦ã€æ­¥è¡Œã€éª‘è¡Œ -->
            <!-- ç‚¹å‡»panelä¸­çš„æ­¥éª¤ä¼šè‡ªåŠ¨æ ‡çº¢å¯¹åº”è·¯æ®µ -->
            <div id="routeInfo"></div>
        </div>
    </div>

    <!-- é«˜å¾·åœ°å›¾å®‰å…¨å¯†é’¥é…ç½® -->
    <script type="text/javascript">
      // ä»æœåŠ¡å™¨APIè·å–é…ç½®å¯†é’¥
      let amapKey = ''; // é»˜è®¤å€¼
      let amapSecurityCode = ''; // é»˜è®¤å€¼
      
      // å¼‚æ­¥è·å–é…ç½®
      fetch('/api/map-config')
        .then(response => response.json())
        .then(config => {
          amapKey = config.webApiKey || amapKey;
          amapSecurityCode = config.securityJsCode || amapSecurityCode;
          
          // è®¾ç½®å®‰å…¨é…ç½®
          window._AMapSecurityConfig = {
            securityJsCode: amapSecurityCode,
          };
          
          // åŠ¨æ€åŠ è½½åœ°å›¾API
          const script = document.createElement('script');
          script.src = 'https://webapi.amap.com/maps?v=2.0&key=' + amapKey + '&plugin=AMap.Driving,AMap.Walking,AMap.Riding,AMap.Geocoder,AMap.Weather';
          script.onload = function() {
            initMap(); // åœ°å›¾APIåŠ è½½å®Œæˆååˆå§‹åŒ–åœ°å›¾
          };
          document.head.appendChild(script);
        })
        .catch(error => {
          console.error('è·å–åœ°å›¾é…ç½®å¤±è´¥ï¼Œä½¿ç”¨é»˜è®¤é…ç½®:', error);
          // ä½¿ç”¨é»˜è®¤é…ç½®
          window._AMapSecurityConfig = {
            securityJsCode: amapSecurityCode,
          };
          const script = document.createElement('script');
          script.src = 'https://webapi.amap.com/maps?v=2.0&key=' + amapKey + '&plugin=AMap.Driving,AMap.Walking,AMap.Riding,AMap.Geocoder,AMap.Weather';
          script.onload = function() {
            initMap();
          };
          document.head.appendChild(script);
        });
    </script>
    
    <script type="text/javascript">
        // ä»URLå‚æ•°è·å–æ•°æ®
        const urlParams = new URLSearchParams(window.location.search);
        const startLng = parseFloat(urlParams.get('startLng'));
        const startLat = parseFloat(urlParams.get('startLat'));
        const endLng = parseFloat(urlParams.get('endLng'));
        const endLat = parseFloat(urlParams.get('endLat'));
        
        // URLä¸­å¯èƒ½æ˜¯ä¸­æ–‡ï¼Œéœ€è¦æ˜ å°„
        let rawMode = urlParams.get('mode') || 'driving';
        const modeMap = {
            'é©¾è½¦': 'driving',
            'å¼€è½¦': 'driving',
            'è‡ªé©¾': 'driving',
            'æ­¥è¡Œ': 'walking',
            'èµ°è·¯': 'walking',
            'éª‘è¡Œ': 'riding',
            'éª‘è½¦': 'riding',
            'è‡ªè¡Œè½¦': 'riding'
        };
        const mode = modeMap[rawMode] || rawMode || 'driving';
        
        // è·å–policyå‚æ•°ï¼ˆç”¨äºé©¾è½¦è·¯çº¿è§„åˆ’ç­–ç•¥ï¼‰
        const policy = urlParams.get('policy');
        
        // å‡ºè¡Œæ–¹å¼æ˜¾ç¤ºæ–‡æœ¬
        const modeTextMap = {
            'driving': 'é©¾è½¦',
            'walking': 'æ­¥è¡Œ',
            'riding': 'éª‘è¡Œ'
        };
        const modeText = modeTextMap[mode] || 'é©¾è½¦';
        
        let map;
        let routePlanner; // é€šç”¨çš„è·¯çº¿è§„åˆ’å™¨
        
        // åˆå§‹åŒ–åœ°å›¾
        function initMap() {
            console.log('å½“å‰å‡ºè¡Œæ–¹å¼ï¼š', mode);
            map = new AMap.Map('map', {
                zoom: 10,
                resizeEnable: true
            });
            
            // æ ¹æ®modeé€‰æ‹©ä¸åŒçš„è·¯çº¿è§„åˆ’æ’ä»¶
            let pluginName = '';
            let constructorName = '';
            
            if (mode === 'walking') {
                pluginName = 'AMap.Walking';
                constructorName = 'Walking';
            } else if (mode === 'riding') {
                pluginName = 'AMap.Riding';
                constructorName = 'Riding';
            } else {
                pluginName = 'AMap.Driving';
                constructorName = 'Driving';
            }
            
            console.log('ä½¿ç”¨æ’ä»¶ï¼š', pluginName);
            
            // åŠ è½½å¯¹åº”çš„è·¯çº¿è§„åˆ’æ’ä»¶
            AMap.plugin([pluginName], function() {
                console.log('æ’ä»¶åŠ è½½å®Œæˆï¼Œåˆ›å»ºå®ä¾‹');
                
                // æ‰€æœ‰å‡ºè¡Œæ–¹å¼éƒ½æ”¯æŒpanelå‚æ•°
                const config = {
                    map: map,
                    panel: 'routeInfo',  // ä½¿ç”¨å®˜æ–¹çš„panel
                    hideMarkers: false
                };
                
                // é©¾è½¦æ¨¡å¼æ·»åŠ policyç­–ç•¥é…ç½®
                if (mode === 'driving' && policy) {
                    config.policy = parseInt(policy);
                    console.log('è®¾ç½®é©¾è½¦è·¯çº¿ç­–ç•¥ï¼š', config.policy);
                }
                
                // åˆ›å»ºè·¯çº¿è§„åˆ’å®ä¾‹
                routePlanner = new AMap[constructorName](config);
                
                console.log('å¼€å§‹è§„åˆ’è·¯çº¿ï¼Œmode=', mode);
                
                // è§„åˆ’è·¯çº¿
                routePlanner.search(new AMap.LngLat(startLng, startLat), new AMap.LngLat(endLng, endLat), (status, result) => {
                    console.log('è·¯çº¿è§„åˆ’çŠ¶æ€ï¼š', status, result);
                    if (status === 'complete') {
                        // è·å–å¤©æ°”ä¿¡æ¯
                        fetchWeather(startLng, startLat, 'å‡ºå‘åœ°');
                        fetchWeather(endLng, endLat, 'ç›®çš„åœ°');
                        // é«˜å¾·å®˜æ–¹çš„panelä¼šè‡ªåŠ¨æ¸²æŸ“å¯¼èˆªæ­¥éª¤ï¼ŒåŒ…æ‹¬é©¾è½¦ã€æ­¥è¡Œã€éª‘è¡Œ
                    } else {
                        console.error('è·¯çº¿è§„åˆ’å¤±è´¥ï¼š', status, result);
                        
                        // å‹å¥½çš„é”™è¯¯æç¤º
                        let errorMsg = '';
                        if (status === 'OVER_DIRECTION_RANGE') {
                            if (mode === 'walking') {
                                errorMsg = 'âŒ æ­¥è¡Œè·¯çº¿ä¸æ”¯æŒè·¨åŸå¸‚è§„åˆ’<br>è·ç¦»å¤ªè¿œï¼Œå»ºè®®ä½¿ç”¨é©¾è½¦æˆ–é«˜é“';
                            } else if (mode === 'riding') {
                                errorMsg = 'âŒ éª‘è¡Œè·¯çº¿ä¸æ”¯æŒè·¨åŸå¸‚è§„åˆ’<br>è·ç¦»å¤ªè¿œï¼Œå»ºè®®ä½¿ç”¨é©¾è½¦';
                            } else {
                                errorMsg = 'âŒ è·ç¦»è¶…å‡ºèŒƒå›´ï¼Œè¯·ç¼©çŸ­è·ç¦»åé‡è¯•';
                            }
                        } else {
                            errorMsg = 'âŒ è·¯çº¿è§„åˆ’å¤±è´¥ï¼š' + status;
                        }
                        
                        document.getElementById('routeInfo').innerHTML = 
                            '<div style="padding: 20px; text-align: center; color: #666;">' + errorMsg + '</div>';
                    }
                });
            });
        }


        
        // è·å–å¤©æ°”ä¿¡æ¯
        function fetchWeather(lng, lat, location) {
            // å…ˆåŠ è½½é€†åœ°ç†ç¼–ç æ’ä»¶
            AMap.plugin('AMap.Geocoder', function() {
                // ä½¿ç”¨é«˜å¾·åœ°å›¾çš„é€†åœ°ç†ç¼–ç è·å–åŸå¸‚
                const geocoder = new AMap.Geocoder();
                
                geocoder.getAddress([lng, lat], function(status, result) {
                    if (status === 'complete' && result.info === 'OK') {
                        const cityName = result.regeocode.addressComponent.city || 
                                       result.regeocode.addressComponent.province || 
                                       'æœªçŸ¥';
                        const district = result.regeocode.addressComponent.district || cityName;
                        
                        // åŠ è½½å¤©æ°”æ’ä»¶å¹¶æŸ¥è¯¢å¤©æ°”
                        AMap.plugin('AMap.Weather', function() {
                            const weather = new AMap.Weather();
                            
                            // æŸ¥è¯¢å®æ—¶å¤©æ°”
                            weather.getLive(district, function(err, data) {
                                if (!err && data) {
                                    displayWeather(location, {
                                        city: cityName,
                                        temperature: data.temperature + 'Â°',
                                        weather: data.weather,
                                        wind: data.windDirection + data.windPower + 'çº§'
                                    });
                                } else {
                                    // å¦‚æœå®æ—¶å¤©æ°”å¤±è´¥ï¼Œå°è¯•æŸ¥è¯¢é¢„æŠ¥å¤©æ°”
                                    weather.getForecast(district, function(err, forecastData) {
                                        if (!err && forecastData && forecastData.forecasts && forecastData.forecasts.length > 0) {
                                            const today = forecastData.forecasts[0];
                                            displayWeather(location, {
                                                city: cityName,
                                                temperature: today.daytemp + 'Â°',
                                                weather: today.dayweather,
                                                wind: today.daywind
                                            });
                                        } else {
                                            displayWeather(location, {
                                                city: cityName,
                                                temperature: '--',
                                                weather: 'æš‚æ— ',
                                                wind: ''
                                            });
                                        }
                                    });
                                }
                            });
                        });
                    } else {
                        displayWeather(location, {
                            city: 'æœªçŸ¥',
                            temperature: '--',
                            weather: 'æš‚æ— ',
                            wind: ''
                        });
                    }
                });
            });
        }
        
        // æ˜¾ç¤ºå¤©æ°”ä¿¡æ¯ - ç´§å‡‘ç‰ˆæœ¬
        function displayWeather(location, weather) {
            const routeInfo = document.getElementById('routeInfo');
            
            // æ£€æŸ¥æ˜¯å¦å·²å­˜åœ¨å¤©æ°”å®¹å™¨
            let weatherContainer = document.getElementById(`weather-${location}`);
            if (!weatherContainer) {
                weatherContainer = document.createElement('div');
                weatherContainer.className = 'info-section';
                weatherContainer.id = `weather-${location}`;
                // æ’å…¥åˆ°routeInfoçš„æœ€å‰é¢
                if (routeInfo.firstChild) {
                    routeInfo.insertBefore(weatherContainer, routeInfo.firstChild);
                } else {
                    routeInfo.appendChild(weatherContainer);
                }
            }
            
            // ç®€æ´çš„å¤©æ°”æ˜¾ç¤ºï¼šåŸå¸‚ | æ¸©åº¦ | å¤©æ°” | é£åŠ›
            weatherContainer.innerHTML = `
                <h3>ğŸŒ¤ï¸ ${location}</h3>
                <div style="display: flex; gap: 12px; font-size: 13px; color: #666;">
                    <span><strong>${weather.city}</strong></span>
                    <span style="color: #333;"><strong>${weather.temperature}</strong></span>
                    <span>${weather.weather}</span>
                    ${weather.wind ? `<span>${weather.wind}</span>` : ''}
                </div>
            `;
        }
        
        // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–åœ°å›¾
        window.onload = function() {
            initMap();
        };
    </script>
</body>
</html>

